<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <base href="/test/">
  <title>DLR Zin content management</title>
</head>
<body>
  <script>
    (function() {
      async function sha256(str) {
        const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
        return Array.from(new Uint8Array(buf))
          .map(b => b.toString(16).padStart(2, "0")).join("");
      }

      const originalFetch = window.fetch;
      window.fetch = async function(url, options) {
        if (
          options &&
          options.method &&
          options.method.toUpperCase() === "POST" &&
          typeof url === "string" &&
          url.includes("/git/commits")
        ) {
          try {
            const body = JSON.parse(options.body);
            console.log("before:", JSON.parse(JSON.stringify(body)));
            const hash = body.author?.email ? await sha256(body.author.email) : "unknown";
            if (body.author) {
              body.author = { ...body.author, email: hash };
            }
            if (body.committer) {
              body.committer = { ...body.committer, email: hash };
            }
            console.log("after:", JSON.parse(JSON.stringify(body)));
            options = { ...options, body: JSON.stringify(body) };
          } catch (e) {
            console.warn("error while modifying /git/commit/:", e);
          }
        }
        return originalFetch.apply(this, [url, options]);
      };
    })();  </script>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <script>
    var FocalPointControl = createClass({
      getInitialState: function() {
        return { naturalWidth: 0, naturalHeight: 0, dragging: false };
      },

      componentWillUnmount: function() {
        document.removeEventListener('mousemove', this.handleMouseMove);
        document.removeEventListener('mouseup', this.handleMouseUp);
      },

      handleImageLoad: function(e) {
        this.setState({
          naturalWidth: e.target.naturalWidth,
          naturalHeight: e.target.naturalHeight
        });
      },

      // Rectangle size as fraction of image (0–1), fitting 16:9 inside the image.
      getRectFractions: function() {
        var nw = this.state.naturalWidth;
        var nh = this.state.naturalHeight;
        if (!nw || !nh) return null;
        var imgRatio = nw / nh;
        var target = 16 / 9;
        return imgRatio > target
          ? { w: target / imgRatio, h: 1 }
          : { w: 1, h: imgRatio / target };
      },

      // object-position "X% Y%" → rectangle top-left as fraction of image.
      valueToPosXY: function(value, rf) {
        var parts = (value || '50% 50%').split(/\s+/);
        var xp = parseFloat(parts[0]) || 50;
        var yp = parseFloat(parts[1]) || 50;
        return {
          x: (1 - rf.w) > 0.0001 ? (xp / 100) * (1 - rf.w) : 0,
          y: (1 - rf.h) > 0.0001 ? (yp / 100) * (1 - rf.h) : 0
        };
      },

      // Rectangle top-left as fraction → object-position "X% Y%".
      posXYToValue: function(px, py, rf) {
        var xp = (1 - rf.w) > 0.0001 ? Math.round(px / (1 - rf.w) * 100) : 50;
        var yp = (1 - rf.h) > 0.0001 ? Math.round(py / (1 - rf.h) * 100) : 50;
        return Math.max(0, Math.min(100, xp)) + '% ' + Math.max(0, Math.min(100, yp)) + '%';
      },

      updateFromMouse: function(clientX, clientY) {
        var rf = this.getRectFractions();
        if (!rf || !this._containerRect) return;
        var cr = this._containerRect;
        var fx = (clientX - cr.left) / cr.width;
        var fy = (clientY - cr.top) / cr.height;
        var px = Math.max(0, Math.min(1 - rf.w, fx - rf.w / 2));
        var py = Math.max(0, Math.min(1 - rf.h, fy - rf.h / 2));
        this.props.onChange(this.posXYToValue(px, py, rf));
      },

      handleMouseDown: function(e) {
        e.preventDefault();
        this._containerRect = e.currentTarget.getBoundingClientRect();
        this.updateFromMouse(e.clientX, e.clientY);
        this.setState({ dragging: true });
        document.addEventListener('mousemove', this.handleMouseMove);
        document.addEventListener('mouseup', this.handleMouseUp);
      },

      handleMouseMove: function(e) {
        if (!this.state.dragging) return;
        this.updateFromMouse(e.clientX, e.clientY);
      },

      handleMouseUp: function() {
        this.setState({ dragging: false });
        this._containerRect = null;
        document.removeEventListener('mousemove', this.handleMouseMove);
        document.removeEventListener('mouseup', this.handleMouseUp);
      },

      render: function() {
        var value = this.props.value || '50% 50%';
        var image = this.props.entry.getIn(['data', 'image']);
        if (!image) {
          return h('p', {}, 'Najpierw dodaj obrazek wyróżniający.');
        }

        var rf = this.getRectFractions();
        var pos = rf ? this.valueToPosXY(value, rf) : null;

        return h('div', {},
          h('div', {
            style: {
              position: 'relative',
              display: 'inline-block',
              cursor: this.state.dragging ? 'grabbing' : 'crosshair',
              maxWidth: '100%',
              userSelect: 'none',
              WebkitUserSelect: 'none',
              overflow: 'hidden'
            },
            onMouseDown: this.handleMouseDown
          },
            h('img', {
              src: image,
              onLoad: this.handleImageLoad,
              style: { maxWidth: '100%', display: 'block', pointerEvents: 'none' },
              draggable: false
            }),
            rf && pos ? h('div', {
              style: {
                position: 'absolute',
                left: (pos.x * 100) + '%',
                top: (pos.y * 100) + '%',
                width: (rf.w * 100) + '%',
                height: (rf.h * 100) + '%',
                border: '2px solid rgba(255,0,0,0.8)',
                boxShadow: '0 0 0 9999px rgba(0,0,0,0.45)',
                boxSizing: 'border-box',
                pointerEvents: 'none'
              }
            }) : null
          ),
          h('small', { style: { color: '#666' } },
            rf ? 'Widoczny obszar (16:9): ' + value : 'Ładowanie...')
        );
      }
    });

    CMS.registerWidget('focal-point', FocalPointControl);
  </script></body>
</html>
